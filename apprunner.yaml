version: 1.0
runtime: python311

build:
  commands:
    build:
      - "set -Eeuo pipefail"
      - "echo === PY ENV ===; pwd; python -V; python -m pip -V"
      - "echo === TREE (top) ===; ls -la"
      - "echo === TREE (backend) ===; ls -la backend || true"
      - "echo === SHOW requirements.txt (first 200 lines) ===; sed -n '1,200p' backend/requirements.txt || true"

      - "echo === Upgrade toolchain ==="
      - "python -m pip install --upgrade pip setuptools wheel"

      # Single, loud install. No fallbacks, no '|| true'. If it fails, we see the real error.
      - "echo === Installing requirements (verbose) ==="
      - "PIP_DISABLE_PIP_VERSION_CHECK=1 PIP_NO_INPUT=1 python -m pip install -v --no-cache-dir --prefer-binary -r backend/requirements.txt"

      - "echo === Create data dirs ==="
      - "mkdir -p backend/data/uploads backend/data/previews backend/data/outputs"
      
      - "echo === Initialize AI Mastering System ==="
      - "cd backend && python initialize_production_ai.py"

      - "echo === BUILD COMPLETE ==="

  env:
    - name: PYTHONUNBUFFERED
      value: "1"


run:
  runtime-version: "3.11.13"
  command: cd backend && uvicorn app:app --host 0.0.0.0 --port 8000
  network:
    port: 8000
  env:
    - name: PYTHONUNBUFFERED
      value: "1"

